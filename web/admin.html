
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketSafe Admin Panel</title>
    <!-- 
    NOTE: For profile photos to display properly, open this file through a web server:
    - Option 1: Use http://localhost:8000/admin.html (recommended)
    - Option 2: Use file:// protocol but profile photos may not display due to CORS restrictions
    -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-red: #dc3545;
            --dark-red: #b02a37;
            --light-red: #f8d7da;
            --pure-white: #ffffff;
            --pure-black: #000000;
            --light-gray: #f8f9fa;
            --dark-gray: #343a40;
            --medium-gray: #6c757d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--pure-black) 50%, var(--dark-red) 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--pure-white);
            min-height: 100vh;
        }

        /* Header/Navbar */
        .navbar {
            background-color: var(--pure-black) !important;
            border-bottom: 3px solid var(--primary-red);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            padding: 1rem 0;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            font-weight: 700;
            color: var(--pure-white) !important;
            text-decoration: none;
        }

        .navbar-brand img {
            height: 40px;
            width: auto;
            margin-right: 15px;
        }

        .logo-img {
            height: 40px;
            width: auto;
            margin-right: 15px;
            border-radius: 5px;
        }

        .navbar-brand .brand-text {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.5px;
            color: var(--pure-white);
        }

        .navbar-text {
            color: var(--pure-white) !important;
        }

        /* Main Content */
        .main-content {
            background: transparent;
            min-height: calc(100vh - 80px);
            padding: 2rem 0;
        }

        /* Container styling for gradient background */
        .container {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* Stats Cards */
        .stats-card {
            background-color: var(--pure-black) !important;
            border: 2px solid var(--pure-white) !important;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .stats-number {
            font-size: 3rem;
            font-weight: 800;
            color: var(--pure-white) !important;
            line-height: 1;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .stats-label {
            font-size: 1rem;
            color: var(--pure-white) !important;
            margin-top: 0.5rem;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .stats-icon {
            font-size: 2.5rem;
            color: var(--pure-white);
            margin-bottom: 1rem;
        }

        /* Ensure all text inside stats cards is white */
        .stats-card,
        .stats-card *,
        .stats-card .card-body,
        .stats-card .card-body *,
        .card.stats-card,
        .card.stats-card *,
        .card.stats-card .card-body,
        .card.stats-card .card-body * {
            color: var(--pure-white) !important;
        }

        .stats-card .text-white,
        .card.stats-card .text-white {
            color: var(--pure-white) !important;
        }

        /* Override Bootstrap card text color */
        .card.stats-card.text-white {
            color: var(--pure-white) !important;
            background-color: var(--pure-black) !important;
        }

        .card.stats-card.text-white * {
            color: var(--pure-white) !important;
        }

        /* Override Bootstrap card background */
        .card.stats-card {
            background-color: var(--pure-black) !important;
            border: 2px solid var(--pure-white) !important;
        }

        .card.stats-card .card-body {
            background-color: var(--pure-black) !important;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-red), var(--dark-red));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--pure-white);
            font-weight: 700;
            font-size: 1.1rem;
            border: 2px solid var(--primary-red);
        }

        .profile-pic-container {
            width: 45px;
            height: 45px;
            position: relative;
        }

        .profile-pic-small {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-red);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease;
            display: block;
            background-color: var(--light-gray);
        }

        .profile-pic-small:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .verification-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 600;
        }

        .verification-badge.completed {
            background-color: var(--light-red);
            color: var(--primary-red);
            border: 1px solid var(--primary-red);
        }

        .verification-badge.pending {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            border: 1px solid var(--medium-gray);
        }

        .status-badge {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
        }

        .status-pending {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            border: 1px solid var(--medium-gray);
        }

        .status-verified {
            background-color: var(--primary-red);
            color: var(--pure-white);
            border: 1px solid var(--primary-red);
        }

        .status-rejected {
            background-color: var(--pure-black);
            color: var(--pure-white);
            border: 1px solid var(--pure-black);
        }

        .connection-status {
            border-radius: 10px;
            border-left: 4px solid;
        }

        .connection-status.success {
            border-left-color: var(--primary-red);
            background-color: var(--light-red);
        }

        .connection-status.error {
            border-left-color: var(--pure-black);
            background-color: var(--light-gray);
        }

        .connection-status.info {
            border-left-color: var(--medium-gray);
            background-color: var(--light-gray);
        }

        .table {
            background-color: var(--pure-white);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 2px solid var(--pure-black);
        }

        .table thead th {
            background-color: var(--pure-black);
            color: var(--pure-white);
            border: none;
            font-weight: 700;
            padding: 1rem 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tbody td {
            padding: 1rem 0.75rem;
            vertical-align: middle;
            border-top: 1px solid var(--light-gray);
            color: var(--pure-black);
            background-color: var(--pure-white);
        }

        .table tbody tr:hover {
            background-color: var(--light-red);
        }

        .table tbody tr:nth-child(even) {
            background-color: var(--light-gray);
        }

        .table tbody tr:nth-child(even):hover {
            background-color: var(--light-red);
        }

        /* Tab Styling */
        .nav-tabs {
            border-bottom: 2px solid var(--primary-red);
            margin-bottom: 0;
        }

        .nav-tabs .nav-link {
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--medium-gray);
            font-weight: 600;
            padding: 1rem 1.5rem;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link:hover {
            border-color: var(--primary-red);
            color: var(--primary-red);
            background-color: transparent;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-red);
            background-color: transparent;
            border-color: var(--primary-red);
            border-bottom-color: var(--primary-red);
        }

        .tab-content {
            background-color: transparent;
            border: none;
            padding: 0;
        }

        /* Connection Status Styling */
        .connection-status {
            margin-bottom: 1rem;
            border-radius: 8px;
            font-weight: 600;
        }

        .connection-status.success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .connection-status.error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .connection-status.info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        .btn {
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--primary-red);
            border-color: var(--primary-red);
            color: var(--pure-white);
        }

        .btn-primary:hover {
            background-color: var(--dark-red);
            border-color: var(--dark-red);
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--primary-red);
            border-color: var(--primary-red);
            color: var(--pure-white);
        }

        .btn-success:hover {
            background-color: var(--dark-red);
            border-color: var(--dark-red);
        }

        .btn-danger {
            background-color: var(--pure-black);
            border-color: var(--pure-black);
            color: var(--pure-white);
        }

        .btn-danger:hover {
            background-color: var(--dark-gray);
            border-color: var(--dark-gray);
        }

        .btn-outline-secondary {
            color: var(--dark-gray);
            border-color: var(--medium-gray);
        }

        .btn-outline-secondary:hover {
            background-color: var(--dark-gray);
            border-color: var(--dark-gray);
            color: var(--pure-white);
        }

        /* Additional styling */
        .card {
            border: 2px solid var(--pure-black);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            background-color: var(--pure-white);
        }

        .card-header {
            background-color: var(--pure-black);
            color: var(--pure-white);
            border-bottom: none;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .loading-spinner {
            color: var(--primary-red);
        }

        .alert {
            border-radius: 10px;
            border: 2px solid;
        }

        .alert-success {
            background-color: var(--light-red);
            border-color: var(--primary-red);
            color: var(--primary-red);
        }

        .alert-danger {
            background-color: var(--light-gray);
            border-color: var(--pure-black);
            color: var(--pure-black);
        }

        .alert-info {
            background-color: var(--light-gray);
            border-color: var(--medium-gray);
            color: var(--dark-gray);
        }

        .modal-content {
            border: 2px solid var(--pure-black);
            border-radius: 15px;
        }

        .modal-header {
            background-color: var(--pure-black);
            color: var(--pure-white);
            border-bottom: none;
        }
        
        /* User modal text styling */
        .modal-body h6 {
            color: var(--primary-red) !important;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--primary-red);
            padding-bottom: 0.5rem;
        }
        
        .modal-body .mb-3 {
            color: var(--pure-black) !important;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .modal-body strong {
            color: var(--pure-black) !important;
            font-weight: 600;
        }
        
        .modal-body code {
            background: var(--light-gray);
            color: var(--primary-red) !important;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .modal-footer {
            border-top: 1px solid var(--light-gray);
        }

        .face-image {
            max-width: 100%;
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--primary-red);
        }
        
        .face-image-container {
            text-align: center;
            background: var(--light-gray);
            border-radius: 12px;
            padding: 10px;
            border: 1px solid var(--medium-gray);
        }
        
        .face-image-label {
            font-size: 0.8rem;
            color: var(--primary-red);
            font-weight: 600;
            margin-top: 5px;
            text-align: center;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--secondary-color);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="logo.png" alt="MarketSafe Logo" class="logo-img">
                <span class="brand-text">MARKETSAFE</span>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container-fluid">
            <!-- Connection Status -->
            <div id="connectionStatus" class="alert connection-status" style="display: none;"></div>

        <!-- Dashboard Stats -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="mb-3">
                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </h2>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="stats-number" id="totalUsers">0</div>
                                <div class="stats-label">Total Users</div>
                            </div>
                            <div>
                                <i class="fas fa-users fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="stats-number" id="pendingUsers">0</div>
                                <div class="stats-label">Pending Verification</div>
                            </div>
                            <div>
                                <i class="fas fa-clock fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="stats-number" id="verifiedUsers">0</div>
                                <div class="stats-label">Verified Users</div>
                            </div>
                            <div>
                                <i class="fas fa-check-circle fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="stats-number" id="rejectedUsers">0</div>
                                <div class="stats-label">Rejected Users</div>
                            </div>
                            <div>
                                <i class="fas fa-times-circle fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="row mb-4">
            <div class="col-12">
                <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab" aria-controls="users" aria-selected="true">
                            <i class="fas fa-users me-2"></i>User Management
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab" aria-controls="products" aria-selected="false">
                            <i class="fas fa-shopping-cart me-2"></i>Product Moderation
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content" id="adminTabsContent">
            <!-- User Management Tab -->
            <div class="tab-pane fade show active" id="users" role="tabpanel" aria-labelledby="users-tab">
                <!-- User Management -->
                <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-0">
                                    <i class="fas fa-users me-2"></i>User Management
                                </h5>
                            </div>
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="searchInput" placeholder="Search users...">
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="statusFilter">
                                            <option value="">All Status</option>
                                            <option value="pending">Pending</option>
                                            <option value="verified">Verified</option>
                                            <option value="rejected">Rejected</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-primary w-100" onclick="loadUsers()">
                                            <i class="fas fa-sync-alt me-1"></i>Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Contact</th>
                                        <th>Status</th>
                                        <th>Face Verification</th>
                                        <th>Registered</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <span class="ms-2">Loading users...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            </div>

            <!-- Product Moderation Tab -->
            <div class="tab-pane fade" id="products" role="tabpanel" aria-labelledby="products-tab">
                <!-- Product Moderation Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-lg">
                    <div class="card-header bg-dark text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-shopping-cart me-2"></i>Product Moderation
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Product Stats -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h3 id="pendingProducts">0</h3>
                                        <p class="mb-0">Pending Review</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h3 id="approvedProducts">0</h3>
                                        <p class="mb-0">Approved</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <h3 id="rejectedProducts">0</h3>
                                        <p class="mb-0">Rejected</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h3 id="totalProducts">0</h3>
                                        <p class="mb-0">Total Products</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Product Filters -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <input type="text" id="productSearchInput" class="form-control" placeholder="Search products...">
                            </div>
                            <div class="col-md-3">
                                <select id="productStatusFilter" class="form-select">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select id="productCategoryFilter" class="form-select">
                                    <option value="">All Categories</option>
                                    <option value="Electronics">Electronics</option>
                                    <option value="Furniture">Furniture</option>
                                    <option value="Menswear">Menswear</option>
                                    <option value="Womenswear">Womenswear</option>
                                    <option value="Accessories">Accessories</option>
                                    <option value="Vehicle">Vehicle</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-primary w-100" onclick="loadProducts()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Seller</th>
                                        <th>Category</th>
                                        <th>Price</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading products...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user me-2"></i>User Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="userModalBody">
                    <!-- User details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="approveBtn" onclick="updateUserStatus('verified')" style="display: none;">
                        <i class="fas fa-check me-1"></i>Approve
                    </button>
                    <button type="button" class="btn btn-danger" id="rejectBtn" onclick="updateUserStatus('rejected')" style="display: none;">
                        <i class="fas fa-times me-1"></i>Reject
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Face Image Preview Modal -->
    <div class="modal fade" id="faceImageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-image me-2"></i>Face Verification Image
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="faceImagePreview" src="" alt="Face Image" class="img-fluid" style="max-height: 500px; border-radius: 10px;">
                    <div id="faceImageTitle" class="mt-3 text-muted"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-shopping-cart me-2"></i>Product Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="productImages" class="mb-3">
                                <!-- Product images will be loaded here -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4 id="productTitle">Product Title</h4>
                            <p class="text-muted" id="productDescription">Product description</p>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Price:</strong> $<span id="productPrice">0</span>
                                </div>
                                <div class="col-6">
                                    <strong>Condition:</strong> <span id="productCondition">New</span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Category:</strong> <span id="productCategory">Electronics</span>
                                </div>
                                <div class="col-6">
                                    <strong>Status:</strong> <span id="productStatus" class="badge">Pending</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <strong>Seller:</strong> <span id="productSeller">Unknown</span>
                            </div>
                            <div class="mb-3">
                                <strong>Created:</strong> <span id="productCreated">Unknown</span>
                            </div>
                            <div id="rejectionReasonDiv" class="mb-3" style="display: none;">
                                <strong>Rejection Reason:</strong> <span id="productRejectionReason">None</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div id="productActions">
                        <button type="button" class="btn btn-success" id="approveProductBtn" onclick="approveProduct()">
                            <i class="fas fa-check me-1"></i>Approve
                        </button>
                        <button type="button" class="btn btn-danger" id="rejectProductBtn" onclick="showRejectModal()">
                            <i class="fas fa-times me-1"></i>Reject
                        </button>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reject Product Modal -->
    <div class="modal fade" id="rejectProductModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Reject Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="rejectionReason" class="form-label">Rejection Reason</label>
                        <select id="rejectionReason" class="form-select">
                            <option value="">Select a reason...</option>
                            <option value="Inappropriate content">Inappropriate content</option>
                            <option value="Poor quality images">Poor quality images</option>
                            <option value="Misleading description">Misleading description</option>
                            <option value="Prohibited item">Prohibited item</option>
                            <option value="Duplicate listing">Duplicate listing</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="customRejectionReason" class="form-label">Custom Reason (if Other selected)</label>
                        <textarea id="customRejectionReason" class="form-control" rows="3" placeholder="Enter custom rejection reason..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="confirmRejectProduct()">
                        <i class="fas fa-times me-1"></i>Reject Product
                    </button>
                    <button type="button" class="btn btn-warning" onclick="testNotification()">
                        <i class="fas fa-bell me-1"></i>Test Notification
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

<script>
    // Firebase REST API configuration
    const FIREBASE_CONFIG = {
        projectId: 'marketsafe-e57cf',
        databaseId: 'marketsafe', // Your specific database
        apiKey: 'AIzaSyAa-268Fx-XfJTsJLGznwcztd82r2vdf3Q'
    };

    // Firebase REST API endpoints
    const FIREBASE_REST_BASE = `https://firestore.googleapis.com/v1/projects/${FIREBASE_CONFIG.projectId}/databases/${FIREBASE_CONFIG.databaseId}/documents`;

    // Global variables
    let usersData = {};
    let selectedUserId = null;
    
    // Real-time functionality variables
    let socket = null;
    let isConnected = false;
    let autoRefreshInterval = null;
    let lastUpdateTime = null;
    let realTimeNotifications = true;

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
        console.log('MarketSafe Admin Panel loaded with Firebase REST API');
        
        // Set default values for stats cards
        updateDashboardStats({});
        
        // Load users from database
        loadUsers();
        
        setupEventListeners();
        
        // Initialize real-time functionality
        initializeRealTimeFeatures();
        
        // Start auto-refresh
        startAutoRefresh();
    });

    // Setup event listeners
    function setupEventListeners() {
        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            filterUsers(e.target.value);
        });

        // Status filter
        document.getElementById('statusFilter').addEventListener('change', function(e) {
            filterUsersByStatus(e.target.value);
        });

        // Product search functionality
        document.getElementById('productSearchInput').addEventListener('input', function(e) {
            filterProducts(e.target.value);
        });

        // Product status filter
        document.getElementById('productStatusFilter').addEventListener('change', function(e) {
            filterProductsByStatus(e.target.value);
        });

        // Product category filter
        document.getElementById('productCategoryFilter').addEventListener('change', function(e) {
            filterProductsByCategory(e.target.value);
        });

        // Tab switching event listeners
        document.getElementById('users-tab').addEventListener('shown.bs.tab', function (e) {
            console.log('Switched to Users tab');
            // Users data is already loaded on page load
        });

        document.getElementById('products-tab').addEventListener('shown.bs.tab', function (e) {
            console.log('Switched to Products tab');
            // Load products when switching to products tab
            loadProducts();
        });
    }

    // ==================== REAL-TIME FUNCTIONALITY ====================
    
    // Initialize real-time features
    function initializeRealTimeFeatures() {
        console.log('Initializing real-time features...');
        
        // Initialize WebSocket connection (if available)
        initializeWebSocket();
        
        // Add real-time status indicator
        addRealTimeStatusIndicator();
        
        // Add notification settings
        addNotificationSettings();
    }
    
    // Initialize WebSocket connection
    function initializeWebSocket() {
        try {
            // Try to connect to WebSocket server (if available)
            // This would typically connect to your backend WebSocket server
            console.log('WebSocket connection not implemented yet - using polling instead');
            
            // For now, we'll use polling for real-time updates
            updateConnectionStatus('Real-time updates enabled (polling mode)', 'success');
        } catch (error) {
            console.log('WebSocket not available, using polling mode');
            updateConnectionStatus('Real-time updates enabled (polling mode)', 'info');
        }
    }
    
    // Add real-time status indicator to the UI
    function addRealTimeStatusIndicator() {
        const statusContainer = document.querySelector('.main-content .container-fluid');
        if (statusContainer) {
            const realTimeIndicator = document.createElement('div');
            realTimeIndicator.id = 'realTimeIndicator';
            realTimeIndicator.className = 'alert alert-info mb-3';
            realTimeIndicator.style.cssText = 'display: none;';
            realTimeIndicator.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-sync-alt fa-spin me-2"></i>
                        <strong>Real-time Updates Active</strong>
                        <span class="ms-2" id="lastUpdateTime">Last update: Just now</span>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="toggleRealTimeNotifications()">
                            <i class="fas fa-bell me-1"></i>
                            <span id="notificationToggleText">Notifications ON</span>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshDataNow()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh Now
                        </button>
                    </div>
                </div>
            `;
            statusContainer.insertBefore(realTimeIndicator, statusContainer.firstChild);
        }
    }
    
    // Add notification settings
    function addNotificationSettings() {
        // This would add notification permission requests and settings
        console.log('Notification settings initialized');
    }
    
    // Start auto-refresh functionality
    function startAutoRefresh() {
        console.log('Starting auto-refresh...');
        
        // Refresh every 30 seconds
        autoRefreshInterval = setInterval(() => {
            if (isConnected) {
                console.log('Auto-refreshing data...');
                refreshData();
            }
        }, 30000); // 30 seconds
        
        // Show real-time indicator
        const indicator = document.getElementById('realTimeIndicator');
        if (indicator) {
            indicator.style.display = 'block';
        }
        
        isConnected = true;
    }
    
    // Stop auto-refresh
    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
        isConnected = false;
        
        const indicator = document.getElementById('realTimeIndicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
    }
    
    // Refresh data (users and products)
    async function refreshData() {
        try {
            console.log('Refreshing all data...');
            lastUpdateTime = new Date();
            
            // Update last update time
            const lastUpdateElement = document.getElementById('lastUpdateTime');
            if (lastUpdateElement) {
                lastUpdateElement.textContent = `Last update: ${lastUpdateTime.toLocaleTimeString()}`;
            }
            
            // Refresh users if on users tab
            const usersTab = document.getElementById('users-tab');
            if (usersTab && usersTab.classList.contains('active')) {
                await loadUsers();
            }
            
            // Refresh products if on products tab
            const productsTab = document.getElementById('products-tab');
            if (productsTab && productsTab.classList.contains('active')) {
                await loadProducts();
            }
            
            console.log('Data refresh completed');
            
        } catch (error) {
            console.error('Error refreshing data:', error);
        }
    }
    
    // Manual refresh function
    async function refreshDataNow() {
        console.log('Manual refresh triggered');
        await refreshData();
        showSuccess('Data refreshed successfully!');
    }
    
    // Toggle real-time notifications
    function toggleRealTimeNotifications() {
        realTimeNotifications = !realTimeNotifications;
        const toggleText = document.getElementById('notificationToggleText');
        if (toggleText) {
            toggleText.textContent = realTimeNotifications ? 'Notifications ON' : 'Notifications OFF';
        }
        
        if (realTimeNotifications) {
            showSuccess('Real-time notifications enabled');
        } else {
            showSuccess('Real-time notifications disabled');
        }
    }
    
    // Show real-time notification
    function showRealTimeNotification(message, type = 'info') {
        if (!realTimeNotifications) return;
        
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px;';
        notification.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-bell me-2"></i>
                <div>
                    <strong>Real-time Update</strong><br>
                    <small>${message}</small>
                </div>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
            </div>
        `;
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }
    
    // Enhanced approval function with real-time updates
    async function approveUserRealTime(userId, userData) {
        try {
            console.log('Real-time user approval:', userId);
            
            // Show loading state
            showRealTimeNotification('Approving user...', 'info');
            
            // Perform approval
            await updateUserStatus('verified');
            
            // Show success notification
            showRealTimeNotification(`User ${userData.firstName || userData.username || 'Unknown'} approved successfully!`, 'success');
            
            // Update UI immediately
            if (usersData[userId]) {
                usersData[userId].verificationStatus = 'verified';
                usersData[userId].reviewedAt = new Date().toISOString();
                usersData[userId].reviewedBy = 'admin-real-time';
            }
            
            // Refresh display
            displayUsers(usersData);
            updateDashboardStats(usersData);
            
        } catch (error) {
            console.error('Error in real-time approval:', error);
            showRealTimeNotification(`Failed to approve user: ${error.message}`, 'danger');
        }
    }
    
    // Enhanced rejection function with real-time updates
    async function rejectUserRealTime(userId, userData, reason = '') {
        try {
            console.log('Real-time user rejection:', userId, reason);
            
            // Show loading state
            showRealTimeNotification('Rejecting user...', 'info');
            
            // Perform rejection
            await updateUserStatus('rejected');
            
            // Show success notification
            const reasonText = reason ? ` (${reason})` : '';
            showRealTimeNotification(`User ${userData.firstName || userData.username || 'Unknown'} rejected${reasonText}`, 'warning');
            
            // Update UI immediately
            if (usersData[userId]) {
                usersData[userId].verificationStatus = 'rejected';
                usersData[userId].reviewedAt = new Date().toISOString();
                usersData[userId].reviewedBy = 'admin-real-time';
                if (reason) {
                    usersData[userId].rejectionReason = reason;
                }
            }
            
            // Refresh display
            displayUsers(usersData);
            updateDashboardStats(usersData);
            
        } catch (error) {
            console.error('Error in real-time rejection:', error);
            showRealTimeNotification(`Failed to reject user: ${error.message}`, 'danger');
        }
    }
    
    // Enhanced product approval with real-time updates
    async function approveProductRealTime(productId, productData) {
        try {
            console.log('Real-time product approval:', productId);
            
            // Show loading state
            showRealTimeNotification('Approving product...', 'info');
            
            // Perform approval
            await approveProduct(productId);
            
            // Show success notification
            showRealTimeNotification(`Product "${productData.title || 'Untitled'}" approved successfully!`, 'success');
            
            // Update local data immediately
            if (productsData[productId]) {
                productsData[productId].moderationStatus = 'approved';
                productsData[productId].reviewedAt = new Date().toISOString();
                productsData[productId].reviewedBy = 'admin-real-time';
            }
            
            // Refresh display
            displayProducts(productsData);
            updateProductStats(productsData);
            
        } catch (error) {
            console.error('Error in real-time product approval:', error);
            showRealTimeNotification(`Failed to approve product: ${error.message}`, 'danger');
        }
    }
    
    // Enhanced product rejection with real-time updates
    async function rejectProductRealTime(productId, productData, reason = '') {
        try {
            console.log('Real-time product rejection:', productId, reason);
            
            // Show loading state
            showRealTimeNotification('Rejecting product...', 'info');
            
            // Perform rejection
            await confirmRejectProduct();
            
            // Show success notification
            const reasonText = reason ? ` (${reason})` : '';
            showRealTimeNotification(`Product "${productData.title || 'Untitled'}" rejected${reasonText}`, 'warning');
            
            // Update local data immediately
            if (productsData[productId]) {
                productsData[productId].moderationStatus = 'rejected';
                productsData[productId].rejectionReason = reason;
                productsData[productId].reviewedAt = new Date().toISOString();
                productsData[productId].reviewedBy = 'admin-real-time';
            }
            
            // Refresh display
            displayProducts(productsData);
            updateProductStats(productsData);
            
        } catch (error) {
            console.error('Error in real-time product rejection:', error);
            showRealTimeNotification(`Failed to reject product: ${error.message}`, 'danger');
        }
    }
    
    // ==================== END REAL-TIME FUNCTIONALITY ====================

    // Update connection status
    function updateConnectionStatus(message, type) {
        const statusDiv = document.getElementById('connectionStatus');
        if (!statusDiv) {
            console.log(`Connection Status: ${message} (${type})`);
            return;
        }
        
        const iconClass = type === 'success' ? 'fa-check-circle' : 
                         type === 'error' ? 'fa-exclamation-triangle' : 
                         type === 'warning' ? 'fa-exclamation-triangle' : 'fa-spinner fa-spin';
        
        statusDiv.className = `alert connection-status ${type}`;
        statusDiv.innerHTML = `<i class="fas ${iconClass} me-2"></i>${message}`;
        statusDiv.style.display = 'block';
        
        // Auto-hide success messages after 3 seconds
        if (type === 'success') {
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
    }

    // Firebase REST API helper functions
    function convertFirestoreValue(field) {
        if (!field) return null;
        
        if (field.stringValue !== undefined) return field.stringValue;
        if (field.integerValue !== undefined) return parseInt(field.integerValue);
        if (field.doubleValue !== undefined) return parseFloat(field.doubleValue);
        if (field.booleanValue !== undefined) return field.booleanValue;
        if (field.timestampValue !== undefined) return new Date(field.timestampValue);
        if (field.mapValue !== undefined) {
            const result = {};
            if (field.mapValue.fields) {
                Object.keys(field.mapValue.fields).forEach(key => {
                    result[key] = convertFirestoreValue(field.mapValue.fields[key]);
                });
            }
            return result;
        }
        if (field.arrayValue !== undefined) {
            if (field.arrayValue.values) {
                return field.arrayValue.values.map(convertFirestoreValue);
            }
            return [];
        }
        return null;
    }

    // Convert entire Firestore document to product object - SIMPLIFIED VERSION
    function convertFirestoreDocument(fields) {
        if (!fields) return null;
        
        console.log('Converting fields:', fields);
        
        const product = {};
        
        // Convert each field with better error handling
        Object.keys(fields).forEach(key => {
            try {
                const field = fields[key];
                let value = null;
                
                // Handle different Firestore field types
                if (field.stringValue !== undefined) {
                    value = field.stringValue;
                } else if (field.integerValue !== undefined) {
                    value = parseInt(field.integerValue);
                } else if (field.doubleValue !== undefined) {
                    value = parseFloat(field.doubleValue);
                } else if (field.booleanValue !== undefined) {
                    value = field.booleanValue;
                } else if (field.timestampValue !== undefined) {
                    value = new Date(field.timestampValue);
                } else if (field.arrayValue !== undefined && field.arrayValue.values) {
                    value = field.arrayValue.values.map(v => {
                        if (v.stringValue !== undefined) return v.stringValue;
                        return v;
                    });
                } else if (field.mapValue !== undefined && field.mapValue.fields) {
                    // Handle nested objects (like faceData)
                    console.log(`Converting mapValue for field ${key}:`, field.mapValue.fields);
                    value = convertFirestoreDocument(field.mapValue.fields);
                    console.log(`Converted mapValue for ${key}:`, value);
                }
                
                if (value !== null && value !== undefined) {
                    product[key] = value;
                }
            } catch (error) {
                console.warn(`Error converting field ${key}:`, error);
            }
        });
        
        // Set required defaults
        product.moderationStatus = product.moderationStatus || 'pending';
        product.status = product.status || 'active';
        product.views = product.views || 0;
        product.isVerified = product.isVerified || false;
        product.likedBy = product.likedBy || [];
        product.comments = product.comments || [];
        
        console.log('Converted product:', product);
        return product;
    }



    // Load users from Firebase REST API
    async function loadUsers() {
        try {
            console.log('Loading users from marketsafe database via REST API...');
            const response = await fetch(`${FIREBASE_REST_BASE}/users?key=${FIREBASE_CONFIG.apiKey}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Raw Firebase response:', data);
            
            // Reset usersData for this load
            usersData = {};
            
            if (data.documents) {
                data.documents.forEach(doc => {
                    console.log('=== DOCUMENT CONVERSION DEBUG ===');
                    console.log('Raw document:', doc);
                    console.log('Document name:', doc.name);
                    console.log('Document fields:', doc.fields);
                    
                    const userId = doc.name.split('/').pop();
                    const user = convertFirestoreDocument(doc.fields);
                    user.id = userId; // Add the user ID
                    console.log('Converted user:', user);
                    console.log('=== END DOCUMENT CONVERSION DEBUG ===');
                    
                    usersData[userId] = user;
                });
            }
            
            console.log('Processed users data:', usersData);
            console.log('Sample user data:', Object.values(usersData)[0]);
            
            // Check if the updated user still has their data
            if (selectedUserId && usersData[selectedUserId]) {
                console.log('=== POST-UPDATE USER DATA CHECK ===');
                console.log('Updated user data after reload:', usersData[selectedUserId]);
                console.log('User firstName after update:', usersData[selectedUserId].firstName);
                console.log('User email after update:', usersData[selectedUserId].email);
                console.log('User faceData after update:', usersData[selectedUserId].faceData);
                console.log('=== END POST-UPDATE CHECK ===');
            }
            
            console.log(`Loaded ${Object.keys(usersData).length} users from marketsafe database`);
            displayUsers(usersData);
            updateDashboardStats(usersData);
            
        } catch (error) {
            console.error('Error loading users:', error);
            updateConnectionStatus(`Failed to connect to marketsafe database: ${error.message}`, 'error');
            showError('Failed to load users: ' + error.message);
        }
    }

    // Display users in table
    function displayUsers(users) {
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';

        if (Object.keys(users).length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h5>No users found</h5>
                            <p>No users have signed up yet.</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        Object.entries(users).forEach(([userId, user]) => {
            const row = createUserRow(userId, user);
            tbody.appendChild(row);
        });
    }

    // Create user row
    function createUserRow(userId, user) {
        const row = document.createElement('tr');
        const status = user.verificationStatus || 'pending';
        
        // Face verification status
        const faceData = user.faceData || {};
        console.log('Face verification data for user:', userId, faceData);
        
        // Check for face verification data in multiple possible locations
        const blinkCompleted = 
            faceData.blinkCompleted === true ||
            faceData.blinkCompleted === 'true' ||
            faceData.blink_completed === true ||
            faceData.blink_completed === 'true' ||
            user.blinkCompleted === true ||
            user.blinkCompleted === 'true';
        
        const moveCloserCompleted = 
            faceData.moveCloserCompleted === true ||
            faceData.moveCloserCompleted === 'true' ||
            faceData.move_closer_completed === true ||
            faceData.move_closer_completed === 'true' ||
            user.moveCloserCompleted === true ||
            user.moveCloserCompleted === 'true';
        
        const headMovementCompleted = 
            faceData.headMovementCompleted === true ||
            faceData.headMovementCompleted === 'true' ||
            faceData.head_movement_completed === true ||
            faceData.head_movement_completed === 'true' ||
            user.headMovementCompleted === true ||
            user.headMovementCompleted === 'true';
        
        console.log('Checking face verification fields:');
        console.log('blinkCompleted:', blinkCompleted);
        console.log('moveCloserCompleted:', moveCloserCompleted);
        console.log('headMovementCompleted:', headMovementCompleted);
        
        const faceSteps = [
            { name: 'Blink', completed: blinkCompleted },
            { name: 'Move Closer', completed: moveCloserCompleted },
            { name: 'Head Movement', completed: headMovementCompleted }
        ];
        
        console.log('Face steps status:', faceSteps);
        
        const faceStepsHtml = faceSteps.map(step => 
            `<span class="verification-badge ${step.completed ? 'completed' : 'pending'}">${step.name}</span>`
        ).join(' ');
        
        // Profile photo handling - prioritize profilePictureUrl (newer field)
        const profilePhotoUrl = user.profilePictureUrl || user.profilePhotoUrl;
        console.log(`User ${userId} profile photos:`);
        console.log(`  - profilePictureUrl: ${user.profilePictureUrl}`);
        console.log(`  - profilePhotoUrl: ${user.profilePhotoUrl}`);
        console.log(`  - Using: ${profilePhotoUrl}`);
        
        let profilePhotoHtml;
        if (profilePhotoUrl && profilePhotoUrl.trim() !== '') {
            profilePhotoHtml = `
                <div class="profile-pic-container me-3" style="position: relative;">
                    <img src="${profilePhotoUrl}" alt="Profile" class="profile-pic-small" 
                         onerror="console.log('Profile photo failed to load (CORS or 404):', this.src); this.style.display='none'; this.nextElementSibling.style.display='flex';"
                         onload="console.log('Profile photo loaded successfully:', this.src); this.nextElementSibling.style.display='none';">
                    <div class="user-avatar" style="display: none; position: absolute; top: 0; left: 0;">${(user.firstName || user.username || 'U')[0].toUpperCase()}</div>
                </div>
            `;
        } else {
            profilePhotoHtml = `<div class="user-avatar me-3">${(user.firstName || user.username || 'U')[0].toUpperCase()}</div>`;
        }

        row.innerHTML = `
            <td>
                <div class="d-flex align-items-center">
                    ${profilePhotoHtml}
                    <div>
                        <div class="fw-bold">${user.firstName || user.username || 'Unknown User'}</div>
                        <small class="text-muted">ID: ${userId.substring(0, 8)}...</small>
                    </div>
                </div>
            </td>
            <td>
                <div>${user.email || 'N/A'}</div>
                <small class="text-muted">${user.phoneNumber || 'No phone'}</small>
            </td>
            <td>
                <span class="status-badge status-${status}">${status.toUpperCase()}</span>
            </td>
            <td>${faceStepsHtml}</td>
            <td>${formatDate(user.createdAt)}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="viewUser('${userId}')">
                    <i class="fas fa-eye me-1"></i>View
                </button>
            </td>
        `;
        
        return row;
    }

    // Filter users by search term
    function filterUsers(searchTerm) {
        const filteredUsers = {};
        Object.entries(usersData).forEach(([userId, user]) => {
            const searchableText = `
                ${user.firstName || ''}
                ${user.lastName || ''}
                ${user.username || ''}
                ${user.email || ''}
                ${user.phoneNumber || ''}
            `.toLowerCase();
            
            if (searchableText.includes(searchTerm.toLowerCase())) {
                filteredUsers[userId] = user;
            }
        });
        
        displayUsers(filteredUsers);
    }

    // Filter users by status
    function filterUsersByStatus(status) {
        if (!status) {
            displayUsers(usersData);
            return;
        }
        
        const filteredUsers = {};
        Object.entries(usersData).forEach(([userId, user]) => {
            const userStatus = user.verificationStatus || 'pending';
            if (userStatus === status) {
                filteredUsers[userId] = user;
            }
        });
        
        displayUsers(filteredUsers);
    }

    // View user details
    function viewUser(userId) {
        selectedUserId = userId;
        const user = usersData[userId];
        const modalBody = document.getElementById('userModalBody');
        
        // Debug: Log user data
        console.log('=== USER DATA DEBUG ===');
        console.log('Full user object:', user);
        console.log('User firstName:', user.firstName);
        console.log('User lastName:', user.lastName);
        console.log('User username:', user.username);
        console.log('User email:', user.email);
        console.log('User phoneNumber:', user.phoneNumber);
        console.log('User address:', user.address);
        console.log('User age:', user.age);
        console.log('User gender:', user.gender);
        console.log('User birthday:', user.birthday);
        console.log('User faceFeatures:', user.faceFeatures);
        console.log('User faceData:', user.faceData);
        console.log('User verificationStatus:', user.verificationStatus);
        console.log('User createdAt:', user.createdAt);
        console.log('User profilePhotoUrl:', user.profilePhotoUrl);
        console.log('=== END USER DATA DEBUG ===');
        
        // Face verification data - check all possible locations
        const faceData = user.faceData || {};
        console.log('=== COMPLETE USER DATA DEBUG ===');
        console.log('Full user object:', JSON.stringify(user, null, 2));
        console.log('Face data object:', faceData);
        console.log('Face data type:', typeof faceData);
        console.log('Face data keys:', Object.keys(faceData));
        
        // Check for face verification data in different possible locations
        console.log('Checking all possible face verification fields:');
        console.log('user.blinkCompleted:', user.blinkCompleted);
        console.log('user.moveCloserCompleted:', user.moveCloserCompleted);
        console.log('user.headMovementCompleted:', user.headMovementCompleted);
        console.log('user.faceVerification:', user.faceVerification);
        console.log('user.verificationSteps:', user.verificationSteps);
        
        // Check nested face data
        if (faceData && typeof faceData === 'object') {
            console.log('Face data properties:');
            Object.keys(faceData).forEach(key => {
                console.log(`  ${key}:`, faceData[key], typeof faceData[key]);
            });
        }
        
        // Check if faceData is actually an object with properties
        console.log('=== DETAILED FACE DATA ANALYSIS ===');
        console.log('faceData exists:', !!faceData);
        console.log('faceData is object:', typeof faceData === 'object');
        console.log('faceData is null:', faceData === null);
        console.log('faceData is undefined:', faceData === undefined);
        console.log('faceData keys length:', Object.keys(faceData).length);
        
        // Check each specific field
        console.log('faceData.blinkCompleted:', faceData.blinkCompleted, typeof faceData.blinkCompleted);
        console.log('faceData.moveCloserCompleted:', faceData.moveCloserCompleted, typeof faceData.moveCloserCompleted);
        console.log('faceData.headMovementCompleted:', faceData.headMovementCompleted, typeof faceData.headMovementCompleted);
        
        // Check if the data might be nested differently
        console.log('Checking for nested face verification data...');
        if (faceData.faceVerification) {
            console.log('faceData.faceVerification:', faceData.faceVerification);
        }
        if (faceData.verificationSteps) {
            console.log('faceData.verificationSteps:', faceData.verificationSteps);
        }
        
        console.log('=== END COMPLETE USER DATA DEBUG ===');
        
        // Profile photo URL - use same priority as table
        const profilePhotoUrl = user.profilePictureUrl || user.profilePhotoUrl;
        console.log('Modal profile photos:');
        console.log('  - profilePictureUrl:', user.profilePictureUrl);
        console.log('  - profilePhotoUrl:', user.profilePhotoUrl);
        console.log('  - Using for modal:', profilePhotoUrl);
        
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-muted mb-3">Personal Information</h6>
                    <div class="mb-3">
                        <strong>First Name:</strong> ${user.firstName || 'N/A'}
                    </div>
                    <div class="mb-3">
                        <strong>Last Name:</strong> ${user.lastName || 'N/A'}
                    </div>
                    <div class="mb-3">
                        <strong>Username:</strong> ${user.username || 'N/A'}
                    </div>
                    <div class="mb-3">
                        <strong>Email:</strong> ${user.email || 'N/A'}
                    </div>
                    <div class="mb-3">
                        <strong>Phone:</strong> ${user.phoneNumber || 'N/A'}
                    </div>
                    <div class="mb-3">
                        <strong>Address:</strong> ${user.address || 'N/A'}
                    </div>
                    <div class="mb-3">
                        <strong>Age:</strong> ${user.age || 'N/A'}
                    </div>
                    <div class="mb-3">
                        <strong>Gender:</strong> ${user.gender || 'N/A'}
                    </div>
                    <div class="mb-3">
                        <strong>Birthday:</strong> ${formatDate(user.birthday)}
                    </div>
                </div>
                <div class="col-md-6">
                    <h6 class="text-muted mb-3">Account Information</h6>
                    <div class="mb-3">
                        <strong>User ID:</strong> 
                        <code>${userId}</code>
                    </div>
                    <div class="mb-3">
                        <strong>Registration Date:</strong> ${formatDate(user.createdAt)}
                    </div>
                    <div class="mb-3">
                        <strong>Status:</strong> 
                        <span class="status-badge status-${user.verificationStatus || 'pending'}">
                            ${(user.verificationStatus || 'pending').toUpperCase()}
                        </span>
                    </div>
                    <!-- Profile Photo Section -->
                    ${profilePhotoUrl ? `
                    <div class="mb-3">
                        <strong>Profile Photo:</strong>
                        <div class="row mt-2">
                            <div class="col-md-8">
                                <div class="face-image-container">
                                    <img src="${profilePhotoUrl}" alt="Profile Photo" class="face-image" 
                                         onclick="showFaceImagePreview('${profilePhotoUrl}', 'Profile Photo')" 
                                         onerror="console.log('Modal profile photo failed to load:', this.src); this.style.display='none'; this.nextElementSibling.style.display='block';"
                                         onload="console.log('Modal profile photo loaded successfully:', this.src); this.nextElementSibling.style.display='none';"
                                         style="cursor: pointer;" title="Click to enlarge">
                                    <div class="face-image-label" style="display: none;">Profile Photo</div>
                                    <div class="text-muted" style="display: none; padding: 20px; text-align: center;">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        Profile photo failed to load
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : `
                    <div class="mb-3">
                        <strong>Profile Photo:</strong>
                        <div class="text-muted">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            No profile photo uploaded
                        </div>
                    </div>
                    `}
                    ${user.faceFeatures ? `
                    <div class="mb-3">
                        <strong>Face Features:</strong> ${user.faceFeatures.featureCount || 0} dimensions stored
                        ${user.faceFeatures.extractedFrom ? `<br><small class="text-muted">Extracted from: ${user.faceFeatures.extractedFrom}</small>` : ''}
                        ${user.faceFeatures.extractionTimestamp ? `<br><small class="text-muted">Extracted: ${new Date(user.faceFeatures.extractionTimestamp).toLocaleString()}</small>` : ''}
                    </div>
                    ` : ''}
                </div>
            </div>
            
            <hr>
            
            <div class="row">
                <div class="col-12">
                    <h6 class="text-muted mb-3">Face Verification Status</h6>
                    <div class="d-flex gap-3 flex-wrap">
                        <div class="verification-badge ${(faceData.blinkCompleted === true || faceData.blinkCompleted === 'true' || faceData.blink_completed === true || faceData.blink_completed === 'true' || user.blinkCompleted === true || user.blinkCompleted === 'true') ? 'completed' : 'pending'}">
                            <i class="fas fa-${(faceData.blinkCompleted === true || faceData.blinkCompleted === 'true' || faceData.blink_completed === true || faceData.blink_completed === 'true' || user.blinkCompleted === true || user.blinkCompleted === 'true') ? 'check' : 'times'} me-1"></i>
                            Blink Test
                        </div>
                        <div class="verification-badge ${(faceData.moveCloserCompleted === true || faceData.moveCloserCompleted === 'true' || faceData.move_closer_completed === true || faceData.move_closer_completed === 'true' || user.moveCloserCompleted === true || user.moveCloserCompleted === 'true') ? 'completed' : 'pending'}">
                            <i class="fas fa-${(faceData.moveCloserCompleted === true || faceData.moveCloserCompleted === 'true' || faceData.move_closer_completed === true || faceData.move_closer_completed === 'true' || user.moveCloserCompleted === true || user.moveCloserCompleted === 'true') ? 'check' : 'times'} me-1"></i>
                            Move Closer Test
                        </div>
                        <div class="verification-badge ${(faceData.headMovementCompleted === true || faceData.headMovementCompleted === 'true' || faceData.head_movement_completed === true || faceData.head_movement_completed === 'true' || user.headMovementCompleted === true || user.headMovementCompleted === 'true') ? 'completed' : 'pending'}">
                            <i class="fas fa-${(faceData.headMovementCompleted === true || faceData.headMovementCompleted === 'true' || faceData.head_movement_completed === true || faceData.head_movement_completed === 'true' || user.headMovementCompleted === true || user.headMovementCompleted === 'true') ? 'check' : 'times'} me-1"></i>
                            Head Movement Test
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Show/hide action buttons based on current status
        const status = user.verificationStatus || 'pending';
        const approveBtn = document.getElementById('approveBtn');
        const rejectBtn = document.getElementById('rejectBtn');
        
        if (status === 'pending') {
            approveBtn.style.display = 'inline-block';
            rejectBtn.style.display = 'inline-block';
        } else {
            approveBtn.style.display = 'none';
            rejectBtn.style.display = 'none';
        }
        
        new bootstrap.Modal(document.getElementById('userModal')).show();
    }

    // Update user verification status using REST API
    async function updateUserStatus(status) {
        if (!selectedUserId) return;
        
        console.log('=== UPDATE USER STATUS DEBUG ===');
        console.log('Selected user ID:', selectedUserId);
        console.log('New status:', status);
        
        // Get current user data before update
        const currentUser = usersData[selectedUserId];
        console.log('Current user data before update:', currentUser);
        
        try {
            // First, get the current document to preserve all existing data
            console.log('Getting current document before update...');
            const getResponse = await fetch(
                `${FIREBASE_REST_BASE}/users/${selectedUserId}?key=${FIREBASE_CONFIG.apiKey}`
            );
            
            if (!getResponse.ok) {
                throw new Error(`Failed to get current document: ${getResponse.status}`);
            }
            
            const currentDoc = await getResponse.json();
            console.log('Current document from Firestore:', currentDoc);
            
            // Merge current data with new fields
            const updateData = {
                fields: {
                    ...currentDoc.fields, // Preserve all existing fields
                    verificationStatus: { stringValue: status },
                    reviewedAt: { timestampValue: new Date().toISOString() },
                    reviewedBy: { stringValue: 'admin-rest-api' }
                }
            };
            
            console.log('Update data being sent (with preserved fields):', updateData);

            const response = await fetch(
                `${FIREBASE_REST_BASE}/users/${selectedUserId}?key=${FIREBASE_CONFIG.apiKey}`,
                {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData)
                }
            );

            console.log('Response status:', response.status);
            console.log('Response ok:', response.ok);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Response error:', errorText);
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const responseData = await response.json();
            console.log('Response data:', responseData);
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
            
            // Use real-time notification instead of regular success message
            if (realTimeNotifications) {
                showRealTimeNotification(`User ${status} successfully!`, 'success');
            } else {
                showSuccess(`User ${status} successfully!`);
            }
            
            // Update the local user data immediately
            if (usersData[selectedUserId]) {
                usersData[selectedUserId].verificationStatus = status;
                usersData[selectedUserId].reviewedAt = new Date().toISOString();
                usersData[selectedUserId].reviewedBy = 'admin-rest-api';
                console.log('Updated local user data:', usersData[selectedUserId]);
            }
            
            // Refresh data
            console.log('Reloading users after status update...');
            loadUsers();
            
        } catch (error) {
            console.error('Error updating user status:', error);
            if (realTimeNotifications) {
                showRealTimeNotification(`Error updating user status: ${error.message}`, 'danger');
            } else {
                showError('Error updating user status: ' + error.message);
            }
        }
    }

    // Show face image preview in modal
    function showFaceImagePreview(imageUrl, title) {
        document.getElementById('faceImagePreview').src = imageUrl;
        document.getElementById('faceImageTitle').textContent = title;
        new bootstrap.Modal(document.getElementById('faceImageModal')).show();
    }

    // Update dashboard statistics
    function updateDashboardStats(users) {
        console.log('Updating dashboard stats with users:', users);
        
        const stats = {
            total: 0,
            pending: 0,
            verified: 0,
            rejected: 0
        };

        if (users && Object.keys(users).length > 0) {
            Object.values(users).forEach(user => {
                stats.total++;
                const status = user.verificationStatus || 'pending';
                if (stats.hasOwnProperty(status)) {
                    stats[status]++;
                }
            });
        }

        console.log('Calculated stats:', stats);

        // Update the DOM elements with explicit values
        const totalElement = document.getElementById('totalUsers');
        const pendingElement = document.getElementById('pendingUsers');
        const verifiedElement = document.getElementById('verifiedUsers');
        const rejectedElement = document.getElementById('rejectedUsers');

        console.log('Elements found for update:', {
            total: totalElement,
            pending: pendingElement,
            verified: verifiedElement,
            rejected: rejectedElement
        });

        if (totalElement) {
            totalElement.textContent = stats.total.toString();
            console.log('Updated totalUsers to:', stats.total);
        }
        if (pendingElement) {
            pendingElement.textContent = stats.pending.toString();
            console.log('Updated pendingUsers to:', stats.pending);
        }
        if (verifiedElement) {
            verifiedElement.textContent = stats.verified.toString();
            console.log('Updated verifiedUsers to:', stats.verified);
        }
        if (rejectedElement) {
            rejectedElement.textContent = stats.rejected.toString();
            console.log('Updated rejectedUsers to:', stats.rejected);
        }
    }

    // Utility functions
    function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        
        let date;
        if (timestamp instanceof Date) {
            date = timestamp;
        } else if (typeof timestamp === 'string') {
            date = new Date(timestamp);
        } else {
            return 'N/A';
        }
        
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function showSuccess(message) {
        // Create a temporary success alert
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 3000);
    }

    function showError(message) {
        // Create a temporary error alert
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 5000);
    }

    // Generic alert function
    function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 3000);
    }

    // Product Moderation Functions
    let productsData = {};
    let selectedProductId = null;

    // Load products from Firestore
    async function loadProducts() {
        try {
            console.log('Loading products from Firestore...');
            updateConnectionStatus('Loading products...', 'info');
            
            // Update loading state in table
            const tbody = document.getElementById('productsTableBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading products...</td></tr>';
            }
            
            // Add timeout to prevent infinite loading
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
            
            const response = await fetch(`${FIREBASE_REST_BASE}/products?key=${FIREBASE_CONFIG.apiKey}`, {
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            console.log('Products API response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('API Error Response:', errorText);
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Products response:', data);
            
            productsData = {};
            if (data.documents && data.documents.length > 0) {
                console.log(`Found ${data.documents.length} documents`);
                
                data.documents.forEach((doc, index) => {
                    try {
                        const productId = doc.name.split('/').pop();
                        const fields = doc.fields;
                        
                        console.log(`Processing document ${index + 1}/${data.documents.length}: ${productId}`);
                        console.log('Raw product fields:', fields);
                        
                        // Convert the document fields to a product object
                        const convertedProduct = convertFirestoreDocument(fields);
                        console.log('Converted product:', convertedProduct);
                        
                        if (convertedProduct && Object.keys(convertedProduct).length > 0) {
                            productsData[productId] = convertedProduct;
                            console.log(`✅ Successfully stored product: ${productId}`);
                            console.log('Product sellerName:', convertedProduct.sellerName);
                            console.log('Product title:', convertedProduct.title);
                        } else {
                            console.warn(`❌ Skipping invalid product: ${productId}`);
                        }
                    } catch (error) {
                        console.error(`❌ Error processing document ${index + 1}:`, error);
                    }
                });
                
                console.log(`✅ Successfully loaded ${Object.keys(productsData).length} products`);
            } else {
                console.log('ℹ️ No products found in database');
                productsData = {};
            }
            
            displayProducts(productsData);
            updateProductStats(productsData);
            updateConnectionStatus('Products loaded successfully', 'success');
            
        } catch (error) {
            console.error('Error loading products:', error);
            
            let errorMessage = error.message;
            if (error.name === 'AbortError') {
                errorMessage = 'Request timed out. Please try again.';
            }
            
            updateConnectionStatus(`Failed to load products: ${errorMessage}`, 'error');
            
            // Show error in table
            const tbody = document.getElementById('productsTableBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error loading products: ${errorMessage}
                            <br><small>Click the debug button (🐛) for more details</small>
                        </td>
                    </tr>
                `;
            }
        }
    }

    // Display products in table
    function displayProducts(products) {
        const tbody = document.getElementById('productsTableBody');
        if (!tbody) {
            console.error('Products table body not found');
            return;
        }
        
        tbody.innerHTML = '';

        if (!products || Object.keys(products).length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        <i class="fas fa-shopping-cart me-2"></i>
                        No products found. Products will appear here once users start creating listings.
                    </td>
                </tr>
            `;
            return;
        }

        Object.entries(products).forEach(([productId, product]) => {
            try {
                const row = document.createElement('tr');
                
                // Debug: Log product structure
                console.log('Processing product:', productId, product);
                
                // Safely get product image with null checks
                let imageUrl = '';
                if (product && product.imageUrl) {
                    imageUrl = product.imageUrl;
                } else if (product && product.imageUrls && Array.isArray(product.imageUrls) && product.imageUrls.length > 0) {
                    imageUrl = product.imageUrls[0];
                }
                
                let imageHtml = '';
                if (product && product.mediaType === 'video' && product.videoThumbnailUrl) {
                    // Video thumbnail with play icon
                    imageHtml = `
                        <div class="position-relative">
                            <img src="${product.videoThumbnailUrl}" alt="Video Thumbnail" class="rounded" style="width: 50px; height: 50px; object-fit: cover;">
                            <div class="position-absolute top-50 start-50 translate-middle">
                                <i class="fas fa-play-circle text-white" style="font-size: 16px; text-shadow: 0 0 3px rgba(0,0,0,0.8);"></i>
                            </div>
                        </div>
                    `;
                } else if (imageUrl) {
                    // Regular image
                    imageHtml = `<img src="${imageUrl}" alt="Product" class="rounded" style="width: 50px; height: 50px; object-fit: cover;">`;
                } else {
                    // Placeholder
                    imageHtml = '<div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;"><i class="fas fa-image text-muted"></i></div>';
                }
                
                // Status badge with safe access
                const status = (product && product.moderationStatus) ? product.moderationStatus : 'pending';
                const statusClass = status === 'approved' ? 'bg-success' : 
                                  status === 'rejected' ? 'bg-danger' : 'bg-warning';
                const statusText = status.charAt(0).toUpperCase() + status.slice(1);
                
                // Created date with safe access
                const createdAt = (product && product.createdAt) ? new Date(product.createdAt).toLocaleDateString() : 'Unknown';
                
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            ${imageHtml}
                            <div class="ms-2">
                                <div class="fw-bold">${(product && product.title) ? product.title : 'Untitled'}</div>
                                <small class="text-muted">${(product && product.description) ? product.description.substring(0, 50) + '...' : 'No description'}</small>
                            </div>
                        </div>
                    </td>
                    <td>${(product && product.sellerName) ? product.sellerName : (product && product.sellerId && usersData[product.sellerId]) ? (usersData[product.sellerId].firstName || usersData[product.sellerId].username || 'Unknown') : 'Unknown'}</td>
                    <td>${(product && product.category) ? product.category : 'Unknown'}</td>
                    <td>$${(product && product.price) ? product.price : 0}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>${createdAt}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewProduct('${productId}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${status === 'pending' ? `
                            <button class="btn btn-sm btn-success me-1" onclick="approveProduct('${productId}')">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="showRejectModal('${productId}')">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : ''}
                    </td>
                `;
                
                tbody.appendChild(row);
            } catch (error) {
                console.error('Error processing product:', productId, error);
                // Add error row for this product
                const errorRow = document.createElement('tr');
                errorRow.innerHTML = `
                    <td colspan="7" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error displaying product: ${productId}
                    </td>
                `;
                tbody.appendChild(errorRow);
            }
        });
    }

    // Update product statistics
    function updateProductStats(products) {
        const stats = {
            pending: 0,
            approved: 0,
            rejected: 0,
            total: 0
        };

        if (products && Object.keys(products).length > 0) {
            Object.values(products).forEach(product => {
                // Skip null or undefined products
                if (!product) {
                    console.warn('Skipping null product in stats');
                    return;
                }
                
                stats.total++;
                const status = (product && product.moderationStatus) ? product.moderationStatus : 'pending';
                if (stats.hasOwnProperty(status)) {
                    stats[status]++;
                }
            });
        }

        document.getElementById('pendingProducts').textContent = stats.pending;
        document.getElementById('approvedProducts').textContent = stats.approved;
        document.getElementById('rejectedProducts').textContent = stats.rejected;
        document.getElementById('totalProducts').textContent = stats.total;
    }

    // View product details
    function viewProduct(productId) {
        const product = productsData[productId];
        if (!product) return;

        selectedProductId = productId;
        
        // Update modal content
        document.getElementById('productTitle').textContent = product.title || 'Untitled';
        document.getElementById('productDescription').textContent = product.description || 'No description';
        document.getElementById('productPrice').textContent = product.price || 0;
        document.getElementById('productCondition').textContent = product.condition || 'Unknown';
        document.getElementById('productCategory').textContent = product.category || 'Unknown';
        document.getElementById('productSeller').textContent = product.sellerName || 'Unknown';
        document.getElementById('productCreated').textContent = product.createdAt ? new Date(product.createdAt).toLocaleString() : 'Unknown';
        
        // Status
        const status = product.moderationStatus || 'pending';
        const statusElement = document.getElementById('productStatus');
        statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        statusElement.className = `badge ${status === 'approved' ? 'bg-success' : status === 'rejected' ? 'bg-danger' : 'bg-warning'}`;
        
        // Rejection reason
        const rejectionReasonDiv = document.getElementById('rejectionReasonDiv');
        if (status === 'rejected' && product.rejectionReason) {
            document.getElementById('productRejectionReason').textContent = product.rejectionReason;
            rejectionReasonDiv.style.display = 'block';
        } else {
            rejectionReasonDiv.style.display = 'none';
        }
        
        // Product images/videos
        const imagesContainer = document.getElementById('productImages');
        const imageUrl = product.imageUrl || (product.imageUrls && product.imageUrls[0]);
        
        if (product.mediaType === 'video' && product.videoUrl) {
            // Show video player
            imagesContainer.innerHTML = `
                <div class="position-relative">
                    <video controls class="img-fluid rounded" style="max-height: 300px; object-fit: cover; width: 100%;">
                        <source src="${product.videoUrl}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <div class="position-absolute top-0 end-0 m-2">
                        <span class="badge bg-danger">VIDEO</span>
                    </div>
                </div>
            `;
        } else if (imageUrl) {
            // Show image
            imagesContainer.innerHTML = `<img src="${imageUrl}" class="img-fluid rounded" alt="Product Image">`;
        } else {
            // Show placeholder
            imagesContainer.innerHTML = '<div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 200px;"><i class="fas fa-image fa-3x text-muted"></i></div>';
        }
        
        // Show/hide action buttons
        const actionsDiv = document.getElementById('productActions');
        if (status === 'pending') {
            actionsDiv.style.display = 'block';
        } else {
            actionsDiv.style.display = 'none';
        }
        
        new bootstrap.Modal(document.getElementById('productModal')).show();
    }

    // Approve product
    async function approveProduct(productId = null) {
        console.log('🔔 DEBUG: approveProduct function called');
        const id = productId || selectedProductId;
        console.log('🔔 DEBUG: Product ID:', id);
        console.log('🔔 DEBUG: Selected product ID:', selectedProductId);
        if (!id) {
            console.log('🔔 DEBUG: No product ID, returning');
            return;
        }
        
        try {
            console.log('Approving product:', id);
            
            // First, get the current product data to preserve it
            const getResponse = await fetch(`${FIREBASE_REST_BASE}/products/${id}?key=${FIREBASE_CONFIG.apiKey}`);
            if (!getResponse.ok) {
                throw new Error(`Failed to get product data: HTTP ${getResponse.status}`);
            }
            
            const productData = await getResponse.json();
            console.log('Current product data:', productData);
            
            // Update only the moderation fields while preserving all other data
            const updateData = {
                fields: {
                    ...productData.fields, // Preserve all existing fields
                    moderationStatus: { stringValue: 'approved' },
                    reviewedAt: { timestampValue: new Date().toISOString() },
                    reviewedBy: { stringValue: 'admin-rest-api' }
                }
            };
            
            console.log('Updating product with data:', updateData);
            
            const response = await fetch(`${FIREBASE_REST_BASE}/products/${id}?key=${FIREBASE_CONFIG.apiKey}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            console.log('Product approved successfully');
            console.log('🔔 DEBUG: Starting notification creation process...');
            
            // Create notification directly for the seller
            const sellerId = productData.fields?.sellerId?.stringValue;
            console.log('🔔 Product data fields:', productData.fields);
            console.log('🔔 Extracted sellerId:', sellerId);
            console.log('🔔 SellerId type:', typeof sellerId);
            console.log('🔔 SellerId length:', sellerId?.length);
            
            if (sellerId) {
                console.log('🔔 Creating notification directly for seller:', sellerId);
                try {
                    await createNotificationForSeller(productData, 'approved', null, id);
                    console.log('✅ Notification created successfully for approval');
                } catch (notificationError) {
                    console.error('❌ Failed to create notification:', notificationError);
                    // Don't fail the approval if notification creation fails
                }
            } else {
                console.error('❌ No sellerId found in product data!');
                console.error('❌ Product data:', productData);
            }
            
            // Use real-time notification instead of regular alert
            if (realTimeNotifications) {
                showRealTimeNotification('Product approved successfully!', 'success');
            } else {
                showAlert('Product approved successfully!', 'success');
            }
            
            // Close modal and refresh data
            bootstrap.Modal.getInstance(document.getElementById('productModal'))?.hide();
            loadProducts();
            
        } catch (error) {
            console.error('Error approving product:', error);
            if (realTimeNotifications) {
                showRealTimeNotification(`Failed to approve product: ${error.message}`, 'danger');
            } else {
                showAlert(`Failed to approve product: ${error.message}`, 'error');
            }
        }
    }

    // Show reject modal
    function showRejectModal(productId = null) {
        selectedProductId = productId || selectedProductId;
        new bootstrap.Modal(document.getElementById('rejectProductModal')).show();
    }

    // Confirm reject product
    async function confirmRejectProduct() {
        if (!selectedProductId) return;
        
        const reason = document.getElementById('rejectionReason').value;
        const customReason = document.getElementById('customRejectionReason').value;
        
        if (!reason) {
            showAlert('Please select a rejection reason', 'error');
            return;
        }
        
        const finalReason = reason === 'Other' ? customReason : reason;
        if (!finalReason) {
            showAlert('Please provide a rejection reason', 'error');
            return;
        }
        
        try {
            console.log('Rejecting product:', selectedProductId, 'Reason:', finalReason);
            
            // First, get the current product data to preserve it
            const getResponse = await fetch(`${FIREBASE_REST_BASE}/products/${selectedProductId}?key=${FIREBASE_CONFIG.apiKey}`);
            if (!getResponse.ok) {
                throw new Error(`Failed to get product data: HTTP ${getResponse.status}`);
            }
            
            const productData = await getResponse.json();
            console.log('Current product data:', productData);
            
            // Update only the moderation fields while preserving all other data
            const updateData = {
                fields: {
                    ...productData.fields, // Preserve all existing fields
                    moderationStatus: { stringValue: 'rejected' },
                    rejectionReason: { stringValue: finalReason },
                    reviewedAt: { timestampValue: new Date().toISOString() },
                    reviewedBy: { stringValue: 'admin-rest-api' }
                }
            };
            
            console.log('Updating product with data:', updateData);
            
            const response = await fetch(`${FIREBASE_REST_BASE}/products/${selectedProductId}?key=${FIREBASE_CONFIG.apiKey}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            console.log('Product rejected successfully');
            
            // Create notification directly for the seller
            const sellerId = productData.fields?.sellerId?.stringValue;
            console.log('🔔 Product data fields:', productData.fields);
            console.log('🔔 Extracted sellerId:', sellerId);
            console.log('🔔 SellerId type:', typeof sellerId);
            console.log('🔔 SellerId length:', sellerId?.length);
            
            if (sellerId) {
                console.log('🔔 Creating notification directly for seller:', sellerId);
                try {
                    await createNotificationForSeller(productData, 'rejected', finalReason, selectedProductId);
                    console.log('✅ Notification created successfully for rejection');
                } catch (notificationError) {
                    console.error('❌ Failed to create notification:', notificationError);
                    // Don't fail the rejection if notification creation fails
                }
            } else {
                console.error('❌ No sellerId found in product data!');
                console.error('❌ Product data:', productData);
            }
            
            // Use real-time notification instead of regular alert
            if (realTimeNotifications) {
                showRealTimeNotification('Product rejected successfully!', 'warning');
            } else {
                showAlert('Product rejected successfully!', 'success');
            }
            
            // Close modals and refresh data
            bootstrap.Modal.getInstance(document.getElementById('rejectProductModal'))?.hide();
            bootstrap.Modal.getInstance(document.getElementById('productModal'))?.hide();
            loadProducts();
            
        } catch (error) {
            console.error('Error rejecting product:', error);
            if (realTimeNotifications) {
                showRealTimeNotification(`Failed to reject product: ${error.message}`, 'danger');
            } else {
                showAlert(`Failed to reject product: ${error.message}`, 'error');
            }
        }
    }

    // Test notification function
    async function testNotification() {
        console.log('🔔 TEST: Testing notification creation...');
        
        if (!selectedProductId) {
            console.log('🔔 TEST: No product selected');
            alert('Please select a product first');
            return;
        }
        
        try {
            // Get product data
            const getResponse = await fetch(`${FIREBASE_REST_BASE}/products/${selectedProductId}?key=${FIREBASE_CONFIG.apiKey}`);
            if (!getResponse.ok) {
                throw new Error(`Failed to get product data: HTTP ${getResponse.status}`);
            }
            
            const productData = await getResponse.json();
            console.log('🔔 TEST: Product data:', productData);
            
            // Test notification creation
            await createNotificationForSeller(productData, 'approved', null, selectedProductId);
            console.log('🔔 TEST: Notification creation completed');
            alert('Test notification created! Check console for details.');
            
        } catch (error) {
            console.error('🔔 TEST: Error:', error);
            alert('Test failed: ' + error.message);
        }
    }

    // Create notification for seller
    async function createNotificationForSeller(productData, status, rejectionReason = null, productId = null) {
        try {
            console.log('🔔 Creating notification for seller:', status);
            console.log('🔔 Product data:', productData);
            console.log('🔔 Selected product ID:', selectedProductId);
            console.log('🔔 Passed product ID:', productId);
            
            // Extract seller ID and product title from product data
            const sellerId = productData.fields?.sellerId?.stringValue || '';
            const productTitle = productData.fields?.title?.stringValue || 'Untitled Product';
            const finalProductId = productId || selectedProductId;
            
            console.log('🔔 Seller ID:', sellerId);
            console.log('🔔 Product Title:', productTitle);
            console.log('🔔 Final Product ID:', finalProductId);
            
            if (!sellerId) {
                console.warn('No seller ID found for product:', finalProductId);
                return;
            }
            
            if (!finalProductId) {
                console.warn('No product ID available for notification');
                return;
            }
            
            // Create notification data
            const notificationId = `notification_${Date.now()}_${finalProductId}`;
            const notification = {
                id: notificationId,
                userId: sellerId,
                productId: finalProductId,
                productTitle: productTitle,
                type: 'product_status',
                status: status,
                rejectionReason: rejectionReason,
                isRead: false,
                createdAt: new Date().toISOString(),
                title: getNotificationTitle(status),
                message: getNotificationMessage(status, productTitle, rejectionReason)
            };
            
            // Save to Firestore
            console.log('🔔 Creating notification with data:', notification);
            console.log('🔔 Notification ID:', notificationId);
            console.log('🔔 API URL:', `${FIREBASE_REST_BASE}/notifications/${notificationId}?key=${FIREBASE_CONFIG.apiKey}`);
            
            const response = await fetch(`${FIREBASE_REST_BASE}/notifications/${notificationId}?key=${FIREBASE_CONFIG.apiKey}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    fields: {
                        id: { stringValue: notification.id },
                        userId: { stringValue: notification.userId },
                        productId: { stringValue: notification.productId },
                        productTitle: { stringValue: notification.productTitle },
                        type: { stringValue: notification.type },
                        status: { stringValue: notification.status },
                        rejectionReason: { stringValue: notification.rejectionReason || '' },
                        isRead: { booleanValue: notification.isRead },
                        createdAt: { timestampValue: notification.createdAt },
                        title: { stringValue: notification.title },
                        message: { stringValue: notification.message }
                    }
                })
            });
            
            console.log('🔔 Notification creation response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('🔔 Failed to create notification:', errorText);
                throw new Error(`Failed to create notification: HTTP ${response.status} - ${errorText}`);
            }
            
            console.log('✅ Notification created successfully:', notificationId);
            
        } catch (error) {
            console.error('Error creating notification:', error);
        }
    }
    
    // Get notification title based on status
    function getNotificationTitle(status) {
        switch (status) {
            case 'pending':
                return 'Product Under Review ⏳';
            case 'approved':
                return 'Product Approved! 🎉';
            case 'rejected':
                return 'Product Rejected ❌';
            default:
                return 'Product Status Update';
        }
    }
    
    // Get notification message based on status
    function getNotificationMessage(status, productTitle, rejectionReason) {
        switch (status) {
            case 'pending':
                return `Your product "${productTitle}" is under review by our team.`;
            case 'approved':
                return `Great news! Your product "${productTitle}" has been approved and is now live!`;
            case 'rejected':
                const reason = rejectionReason ? `\n\nReason: ${rejectionReason}` : '';
                return `Your product "${productTitle}" has been rejected.${reason}`;
            default:
                return `Your product "${productTitle}" status has been updated.`;
        }
    }

    // Filter products
    function filterProducts(searchTerm) {
        const filteredProducts = {};
        
        Object.entries(productsData).forEach(([productId, product]) => {
            const searchableText = `
                ${product.title || ''}
                ${product.description || ''}
                ${product.category || ''}
                ${product.sellerName || ''}
            `.toLowerCase();
            
            if (searchableText.includes(searchTerm.toLowerCase())) {
                filteredProducts[productId] = product;
            }
        });
        
        displayProducts(filteredProducts);
    }

    // Filter products by status
    function filterProductsByStatus(status) {
        if (!status) {
            displayProducts(productsData);
            return;
        }
        
        const filteredProducts = {};
        Object.entries(productsData).forEach(([productId, product]) => {
            if ((product.moderationStatus || 'pending') === status) {
                filteredProducts[productId] = product;
            }
        });
        
        displayProducts(filteredProducts);
    }

    // Filter products by category
    function filterProductsByCategory(category) {
        if (!category) {
            displayProducts(productsData);
            return;
        }
        
        const filteredProducts = {};
        Object.entries(productsData).forEach(([productId, product]) => {
            if (product.category === category) {
                filteredProducts[productId] = product;
            }
        });
        
        displayProducts(filteredProducts);
    }


</script>
</body>
</html>